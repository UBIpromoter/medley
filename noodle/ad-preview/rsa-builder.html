<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medley — RSA Builder</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #fff; color: #1a1a1a; min-height: 100vh; }

  .layout { display: grid; grid-template-columns: 1fr 380px; min-height: 100vh; }

  /* Left panel */
  .builder { padding: 24px 28px 120px; overflow-y: auto; max-height: 100vh; }
  h1 { font-size: 20px; margin-bottom: 2px; }
  .intro { font-size: 13px; color: #666; margin-bottom: 16px; line-height: 1.5; }

  /* Global counter */
  .counter { display: flex; gap: 16px; padding: 12px 16px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e5e5e5; margin-bottom: 20px; }
  .counter-item { display: flex; align-items: center; gap: 8px; }
  .counter-num { font-size: 22px; font-weight: 700; }
  .counter-num.good { color: #137333; }
  .counter-num.over { color: #d93025; }
  .counter-num.under { color: #f9ab00; }
  .counter-label { font-size: 12px; color: #666; }
  .counter-target { font-size: 11px; color: #999; }
  .counter-bar { flex: 1; }
  .counter-fill { height: 4px; background: #e5e5e5; border-radius: 2px; overflow: hidden; margin-top: 4px; }
  .counter-fill-inner { height: 100%; border-radius: 2px; transition: width 0.3s, background 0.3s; }

  /* Category */
  .cat-header { display: flex; align-items: center; gap: 8px; margin: 20px 0 6px; }
  .cat-header h3 { font-size: 12px; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; flex: 1; }
  .cat-count { font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
  .cat-count.good { background: #e6f4ea; color: #137333; }
  .cat-count.over { background: #fce8e6; color: #d93025; }
  .cat-count.under { background: #fef7e0; color: #b06000; }
  .cat-target { font-size: 11px; color: #bbb; }
  .section-type { font-size: 14px; color: #1a73e8; font-weight: 600; margin: 24px 0 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .section-note { font-size: 12px; color: #999; margin-bottom: 8px; }

  /* Item rows */
  .item { display: flex; align-items: center; gap: 5px; padding: 5px 4px; border-radius: 6px; transition: all 0.15s; cursor: default; }
  .item:hover { background: #f8f9fa; }
  .item.selected { background: #e6f4ea; }
  .item.bench { opacity: 0.45; }
  .item.dragging { opacity: 0.3; }
  .item.drag-over { border-top: 2px solid #1a73e8; }

  .drag-handle { cursor: grab; color: #ccc; font-size: 14px; padding: 0 2px; user-select: none; flex-shrink: 0; }
  .drag-handle:active { cursor: grabbing; }
  .item:hover .drag-handle { color: #999; }

  .rank { width: 20px; font-size: 11px; font-weight: 700; color: #bbb; text-align: center; flex-shrink: 0; }
  .item.selected .rank { color: #137333; }

  .sel-btn { width: 26px; height: 26px; border: 1px solid #dadce0; background: #fff; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; transition: all 0.12s; flex-shrink: 0; }
  .sel-btn:hover { background: #f0f0f0; }
  .sel-btn.on { background: #e6f4ea; border-color: #34a853; color: #137333; }

  .item-text { flex: 1; font-size: 14px; padding: 2px 4px; border-radius: 3px; outline: none; }
  .item-text:focus { background: #eef1ff; box-shadow: 0 0 0 2px rgba(26,115,232,0.12); }
  .item-meta { font-size: 10px; color: #bbb; flex-shrink: 0; }
  .item-meta.over { color: #d93025; font-weight: bold; }
  .item-meta.sweet { color: #137333; }

  .cut-line { border-top: 2px dashed #d93025; margin: 4px 0; position: relative; }
  .cut-line::after { content: "bench"; position: absolute; right: 0; top: -8px; font-size: 9px; color: #d93025; text-transform: uppercase; letter-spacing: 0.5px; background: #fff; padding: 0 4px; }

  /* Right panel */
  .rsa-panel { background: #f8f9fa; border-left: 1px solid #e5e5e5; padding: 24px 20px; overflow-y: auto; max-height: 100vh; position: sticky; top: 0; }
  .rsa-panel h3 { font-size: 14px; color: #1a73e8; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .rsa-panel .sub { font-size: 12px; color: #999; margin-bottom: 16px; }

  .rsa-section { margin-bottom: 20px; }
  .rsa-section h4 { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 6px; }
  .rsa-item { font-size: 13px; padding: 3px 0; color: #333; border-bottom: 1px solid #eee; }
  .rsa-item .rn { color: #bbb; font-size: 11px; margin-right: 4px; }
  .rsa-empty { font-size: 12px; color: #ccc; font-style: italic; }

  .preview-card { background: #fff; border: 1px solid #dadce0; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
  .pv-label { font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px; }
  .pv-h { font-size: 15px; color: #1a0dab; line-height: 1.3; margin-bottom: 2px; }
  .pv-u { font-size: 12px; color: #006621; margin-bottom: 3px; }
  .pv-u .badge { font-size: 10px; font-weight: bold; color: #006621; border: 1px solid #006621; border-radius: 2px; padding: 0 3px; margin-right: 3px; }
  .pv-d { font-size: 12px; color: #4d5156; line-height: 1.4; }

  .ready-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-bottom: 12px; }
  .ready-badge.yes { background: #e6f4ea; color: #137333; }
  .ready-badge.no { background: #fef7e0; color: #b06000; }

  .shuffle-btn { background: #1a73e8; color: #fff; border: none; border-radius: 6px; padding: 5px 14px; font-size: 12px; font-weight: 600; cursor: pointer; margin-bottom: 12px; }
  .shuffle-btn:hover { background: #1557b0; }

  /* Export bar */
  .export-bar { position: fixed; bottom: 0; left: 0; right: 380px; background: #fff; border-top: 1px solid #e5e5e5; padding: 10px 28px; display: flex; gap: 12px; align-items: center; }
  .export-bar button { background: #1a73e8; color: #fff; border: none; border-radius: 6px; padding: 7px 18px; font-size: 13px; font-weight: 600; cursor: pointer; }
  .export-bar button:hover { background: #1557b0; }
  .export-bar button.sec { background: transparent; color: #1a73e8; border: 1px solid #dadce0; }
  .export-bar .stat { font-size: 12px; color: #999; flex: 1; }

  .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; align-items: center; justify-content: center; }
  .overlay.open { display: flex; }
  .overlay-box { background: #fff; border-radius: 12px; max-width: 640px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; }
  .overlay-header { position: sticky; top: 0; background: #fff; padding: 16px 24px 10px; border-bottom: 1px solid #e5e5e5; border-radius: 12px 12px 0 0; display: flex; align-items: center; gap: 12px; }
  .overlay-header h3 { font-size: 16px; flex: 1; }
  .overlay-header button { background: #1a73e8; color: #fff; border: none; border-radius: 6px; padding: 7px 18px; font-size: 13px; font-weight: 600; cursor: pointer; }
  .overlay-header button.close-btn { background: #666; }
  .overlay-body { padding: 16px 24px 24px; overflow-y: auto; flex: 1; }
  .overlay-body pre { background: #f8f9fa; padding: 16px; border-radius: 8px; font-size: 13px; white-space: pre-wrap; line-height: 1.6; }

  @media (max-width: 900px) {
    .layout { grid-template-columns: 1fr; }
    .rsa-panel { position: relative; max-height: none; border-left: none; border-top: 1px solid #e5e5e5; }
    .export-bar { right: 0; }
  }
</style>
</head>
<body>

<div class="layout">

<div class="builder">
  <h1>Medley RSA Builder</h1>
  <p class="intro">Build your Google Responsive Search Ad. Pick <b>15 headlines</b> and <b>4 descriptions</b>. Google will mix 3 headlines + 2 descriptions per impression. Drag to reorder priority. Click to select/deselect.</p>

  <div class="counter" id="counter"></div>

  <div class="section-type">Headlines <span style="font-weight:400;color:#999;font-size:11px;">max 30 chars · pick 15</span></div>

  <div class="cat-header"><h3>The Gap — hooks that stop the scroll</h3><span class="cat-target">pick 3</span><span class="cat-count" id="cc-gap"></span></div>
  <div id="s-gap"></div>

  <div class="cat-header"><h3>The Promise — what they get</h3><span class="cat-target">pick 3</span><span class="cat-count" id="cc-promise"></span></div>
  <div id="s-promise"></div>

  <div class="cat-header"><h3>Credibility — why Medley</h3><span class="cat-target">pick 3</span><span class="cat-count" id="cc-cred"></span></div>
  <div id="s-cred"></div>

  <div class="cat-header"><h3>Audience — who it's for</h3><span class="cat-target">pick 3</span><span class="cat-count" id="cc-aud"></span></div>
  <div id="s-aud"></div>

  <div class="cat-header"><h3>Format & Keywords</h3><span class="cat-target">pick 3</span><span class="cat-count" id="cc-cta"></span></div>
  <div id="s-cta"></div>

  <div class="section-type" style="margin-top:32px;">Descriptions <span style="font-weight:400;color:#999;font-size:11px;">max 90 chars · pick 4 · shorter = better</span></div>
  <div class="section-note">Two show together. Shorter catches eyes. Green = sweet spot (40-65 chars).</div>

  <div class="cat-header"><h3>For Teachers</h3><span class="cat-target">pick 2</span><span class="cat-count" id="cc-dt"></span></div>
  <div id="s-dt"></div>

  <div class="cat-header"><h3>For Admins</h3><span class="cat-target">pick 1</span><span class="cat-count" id="cc-da"></span></div>
  <div id="s-da"></div>

  <div class="cat-header"><h3>Universal</h3><span class="cat-target">pick 1</span><span class="cat-count" id="cc-du"></span></div>
  <div id="s-du"></div>
</div>

<!-- Right panel: Your RSA -->
<div class="rsa-panel">
  <h3>Your RSA</h3>
  <p class="sub">What goes into Google Ads</p>
  <div id="readyBadge"></div>
  <div id="rsaSummary"></div>
  <button class="shuffle-btn" onclick="renderPreviews()">Shuffle Preview</button>
  <div id="previews"></div>
</div>

</div>

<div class="export-bar">
  <span class="stat" id="barStats"></span>
  <button class="sec" onclick="window.open('index.html','_blank')">Visual Preview</button>
  <button onclick="showExport()">Export Final RSA</button>
</div>

<div class="overlay" id="overlay">
  <div class="overlay-box">
    <div class="overlay-header">
      <h3>Your RSA — Ready for Google Ads</h3>
      <button onclick="copyExport()" id="copyBtn">Copy to Clipboard</button>
      <button class="close-btn" onclick="document.getElementById('overlay').classList.remove('open')">Close</button>
    </div>
    <div class="overlay-body">
      <pre id="exportPre"></pre>
    </div>
  </div>
</div>

<script>
const STORAGE_KEY = "medley-rsa-builder-v1";
const H_TARGET = 15;
const D_TARGET = 4;
const DESC_SWEET = [40, 65];

function loadStore() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; } catch { return {}; } }
function saveStore(store) { localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }
function slug(t) { return t.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"").slice(0,50); }

// ================================================
// DATA — Pre-ranked by recommendation (best first)
// Selected = in your RSA. Not selected = bench.
// ================================================
const cats = [
  // HEADLINES
  { id: "gap", type: "h", target: 3, countEl: "cc-gap", containerEl: "s-gap", max: 30, items: [
    { t: "Your Degree Didn't Cover This", sel: true, note: "#1 scroll-stopper" },
    { t: "Not Trained for This?", sel: true, note: "empathetic question" },
    { t: "Nobody Prepared You for This", sel: true, note: "direct, bold" },
    { t: "What Your Degree Missed", sel: false },
    { t: "When Inclusion Feels Hard", sel: false },
    { t: "Not Another Lecture", sel: false },
    { t: "The PD You Actually Need", sel: false },
    { t: "Finally, PD That Fits", sel: false },
    { t: "The PD You Were Missing", sel: false },
  ]},
  { id: "promise", type: "h", target: 3, countEl: "cc-promise", containerEl: "s-promise", max: 30, items: [
    { t: "Tools for Monday Morning", sel: true, note: "concrete, practical" },
    { t: "Strategies That Actually Work", sel: true, note: "addresses PD skepticism" },
    { t: "Teach the Kids You Have", sel: true, note: "philosophy + practical" },
    { t: "Feel Empowered to Teach", sel: false },
    { t: "Every Kid, Every Ability", sel: false },
    { t: "Hands-On Music PD", sel: false },
    { t: "Make Monday Better", sel: false },
    { t: "Reach Every Student", sel: false },
    { t: "Music for ALL Learners", sel: false },
    { t: "Monday Will Be Different", sel: false },
    { t: "Ready for Next Monday", sel: false },
  ]},
  { id: "cred", type: "h", target: 3, countEl: "cc-cred", containerEl: "s-cred", max: 30, items: [
    { t: "Real Teachers Not Consultants", sel: true, note: "strongest credibility" },
    { t: "By Music Teachers", sel: true, note: "clean, simple" },
    { t: "Humans, Not Curriculum", sel: true, note: "Jess's philosophy" },
    { t: "Watch the Children", sel: false, note: "Jess's mantra" },
    { t: "Teachers, Not Talking Heads", sel: false },
    { t: "No Outsiders, Real Teachers", sel: false },
    { t: "Kids First, Lessons Second", sel: false },
    { t: "We See Kids, Not Labels", sel: false },
    { t: "Made by Music Teachers", sel: false },
    { t: "We're Music Teachers Too", sel: false },
  ]},
  { id: "aud", type: "h", target: 3, countEl: "cc-aud", containerEl: "s-aud", max: 30, items: [
    { t: "For Music Teachers", sel: true, note: "clear teacher signal" },
    { t: "Equip Your Music Teachers", sel: true, note: "admin action verb" },
    { t: "Schools & Districts", sel: true, note: "admin signal" },
    { t: "PD Teachers Actually Request", sel: false },
    { t: "Train Your Music Dept", sel: false },
  ]},
  { id: "cta", type: "h", target: 3, countEl: "cc-cta", containerEl: "s-cta", max: 30, items: [
    { t: "Inclusive Music PD", sel: true, note: "keyword match" },
    { t: "Adaptive Music Ed", sel: true, note: "keyword variation" },
    { t: "Virtual & In-Person", sel: true, note: "format flexibility" },
    { t: "See What We Offer", sel: false },
  ]},

  // DESCRIPTIONS
  { id: "dt", type: "d", target: 2, countEl: "cc-dt", containerEl: "s-dt", max: 90, items: [
    { t: "We teach what your degree didn't. By music teachers.", sel: true, note: "52 — punchiest" },
    { t: "You were trained for music, not disability. We bridge that gap.", sel: true, note: "62 — Jess's voice" },
    { t: "Not theory. Hands-on skills your program skipped. Use them Monday.", sel: false },
    { t: "The skills your program skipped. We'll get you there.", sel: false },
    { t: "Stop feeling lost. Fellow music teachers show you what works.", sel: false },
    { t: "Your degree covered the curriculum, not every learner. We cover the rest.", sel: false },
    { t: "Weren't trained for this? We'll get you there. Practical inclusion PD.", sel: false },
    { t: "Fill the gap your degree left. Real strategies for inclusive classrooms.", sel: false },
    { t: "Bridge what your degree missed. Hands-on strategies that work.", sel: false },
    { t: "Feel empowered to include every student. Monday will look different.", sel: false },
    { t: "Your program left gaps. We fill them with practical strategies.", sel: false },
  ]},
  { id: "da", type: "d", target: 1, countEl: "cc-da", containerEl: "s-da", max: 90, items: [
    { t: "Your music teachers weren't trained for inclusion. We can help.", sel: true, note: "63 — direct" },
    { t: "Your team needs this. PD by music teachers who get it.", sel: false },
    { t: "PD teachers actually request. By music teachers, not outsiders.", sel: false },
    { t: "Every child in your district deserves music. Equip your team.", sel: false },
    { t: "Inclusion PD that fills the gap their programs left. We come to you.", sel: false },
  ]},
  { id: "du", type: "d", target: 1, countEl: "cc-du", containerEl: "s-du", max: 90, items: [
    { t: "Inclusion PD by music teachers. Practical. Hands-on.", sel: true, note: "52 — staccato" },
    { t: "Strategies you didn't learn in school. Virtual & in-person.", sel: false },
    { t: "The training music teachers actually need. Inclusive, adaptive, hands-on.", sel: false },
    { t: "Inclusion PD that fills the gap. By music teachers, for music teachers.", sel: false },
  ]},
];

// Generate IDs
cats.forEach(cat => cat.items.forEach(item => { item.id = slug(item.t); }));

// Load persisted state
function applyStore() {
  const store = loadStore();
  // Restore selection and order
  cats.forEach(cat => {
    const saved = store[cat.id];
    if (!saved) return;
    // Restore selections
    if (saved.sels) {
      cat.items.forEach(item => {
        if (saved.sels[item.id] !== undefined) item.sel = saved.sels[item.id];
      });
    }
    // Restore order
    if (saved.order) {
      const orderMap = {};
      saved.order.forEach((id, i) => orderMap[id] = i);
      cat.items.sort((a, b) => {
        const oa = orderMap[a.id] !== undefined ? orderMap[a.id] : 999;
        const ob = orderMap[b.id] !== undefined ? orderMap[b.id] : 999;
        return oa - ob;
      });
    }
    // Restore edited text
    if (saved.texts) {
      cat.items.forEach(item => {
        if (saved.texts[item.id]) item.t = saved.texts[item.id];
      });
    }
  });
}

function persistAll() {
  const store = {};
  cats.forEach(cat => {
    store[cat.id] = {
      sels: {},
      order: cat.items.map(i => i.id),
      texts: {},
    };
    cat.items.forEach(item => {
      store[cat.id].sels[item.id] = item.sel;
      store[cat.id].texts[item.id] = item.t;
    });
  });
  saveStore(store);
}

applyStore();

// ================================================
// DRAG STATE
// ================================================
let dragCat = null;
let dragIdx = null;

// ================================================
// RENDER
// ================================================
function render() {
  cats.forEach(cat => {
    const container = document.getElementById(cat.containerEl);
    container.innerHTML = "";

    // Sort: selected first, then bench
    const selected = cat.items.filter(i => i.sel);
    const bench = cat.items.filter(i => !i.sel);

    // Render selected items
    selected.forEach((item, i) => renderRow(container, item, i + 1, cat, true));

    // Cut line if there are bench items
    if (bench.length > 0 && selected.length > 0) {
      const line = document.createElement("div");
      line.className = "cut-line";
      container.appendChild(line);
    }

    // Render bench
    bench.forEach((item, i) => renderRow(container, item, selected.length + i + 1, cat, false));

    // Category count
    const countEl = document.getElementById(cat.countEl);
    const count = selected.length;
    countEl.textContent = `${count}/${cat.target}`;
    countEl.className = "cat-count " + (count === cat.target ? "good" : count > cat.target ? "over" : "under");
  });

  renderCounter();
  renderRSA();
  persistAll();
}

function renderRow(container, item, rank, cat, isSelected) {
  const row = document.createElement("div");
  row.className = "item" + (isSelected ? " selected" : " bench");
  row.draggable = true;

  row.addEventListener("dragstart", e => {
    dragCat = cat;
    dragIdx = cat.items.indexOf(item);
    row.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
  });
  row.addEventListener("dragend", () => { row.classList.remove("dragging"); });
  row.addEventListener("dragover", e => {
    e.preventDefault();
    if (dragCat !== cat) return;
    row.classList.add("drag-over");
  });
  row.addEventListener("dragleave", () => { row.classList.remove("drag-over"); });
  row.addEventListener("drop", e => {
    e.preventDefault();
    row.classList.remove("drag-over");
    if (dragCat !== cat) return;
    const targetIdx = cat.items.indexOf(item);
    if (dragIdx === targetIdx) return;
    const [moved] = cat.items.splice(dragIdx, 1);
    cat.items.splice(targetIdx, 0, moved);
    render();
  });

  // Drag handle
  const handle = document.createElement("span");
  handle.className = "drag-handle";
  handle.textContent = "\u2630";

  // Rank
  const rankEl = document.createElement("span");
  rankEl.className = "rank";
  rankEl.textContent = rank;

  // Select button
  const btn = document.createElement("button");
  btn.className = "sel-btn" + (isSelected ? " on" : "");
  btn.textContent = isSelected ? "\u2713" : "";
  btn.onclick = (e) => {
    e.stopPropagation();
    item.sel = !item.sel;
    render();
  };

  // Text
  const text = document.createElement("span");
  text.className = "item-text";
  text.contentEditable = true;
  text.textContent = item.t;
  text.addEventListener("input", () => {
    item.t = text.textContent;
    item.id = slug(item.t);
    updateMeta(meta, item.t.length, cat);
    persistAll();
  });
  text.addEventListener("keydown", e => { if (e.key === "Enter") { e.preventDefault(); text.blur(); }});

  // Meta (char count)
  const meta = document.createElement("span");
  updateMeta(meta, item.t.length, cat);

  // Note
  if (item.note) {
    const note = document.createElement("span");
    note.style.cssText = "font-size:10px;color:#bbb;font-style:italic;margin-right:4px;flex-shrink:0;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;";
    note.textContent = item.note;
    note.title = item.note;
    row.append(handle, rankEl, btn, text, note, meta);
  } else {
    row.append(handle, rankEl, btn, text, meta);
  }

  container.appendChild(row);
}

function updateMeta(el, len, cat) {
  el.textContent = `${len}/${cat.max}`;
  el.className = "item-meta";
  if (len > cat.max) el.classList.add("over");
  else if (cat.type === "d" && len >= DESC_SWEET[0] && len <= DESC_SWEET[1]) el.classList.add("sweet");
}

function renderCounter() {
  const hCount = cats.filter(c => c.type === "h").reduce((n, c) => n + c.items.filter(i => i.sel).length, 0);
  const dCount = cats.filter(c => c.type === "d").reduce((n, c) => n + c.items.filter(i => i.sel).length, 0);

  const hClass = hCount === H_TARGET ? "good" : hCount > H_TARGET ? "over" : "under";
  const dClass = dCount === D_TARGET ? "good" : dCount > D_TARGET ? "over" : "under";

  document.getElementById("counter").innerHTML = `
    <div class="counter-item">
      <div><div class="counter-num ${hClass}">${hCount}</div><div class="counter-target">/ ${H_TARGET} headlines</div></div>
      <div class="counter-bar"><div class="counter-fill"><div class="counter-fill-inner" style="width:${Math.min(100, hCount/H_TARGET*100)}%;background:${hClass==='good'?'#34a853':hClass==='over'?'#d93025':'#f9ab00'}"></div></div></div>
    </div>
    <div class="counter-item">
      <div><div class="counter-num ${dClass}">${dCount}</div><div class="counter-target">/ ${D_TARGET} descriptions</div></div>
      <div class="counter-bar"><div class="counter-fill"><div class="counter-fill-inner" style="width:${Math.min(100, dCount/D_TARGET*100)}%;background:${dClass==='good'?'#34a853':dClass==='over'?'#d93025':'#f9ab00'}"></div></div></div>
    </div>
  `;

  document.getElementById("barStats").textContent = `${hCount}/${H_TARGET} headlines \u00b7 ${dCount}/${D_TARGET} descriptions`;
}

function renderRSA() {
  const hSel = [];
  const dSel = [];
  cats.forEach(c => {
    c.items.forEach(item => {
      if (!item.sel) return;
      if (c.type === "h") hSel.push(item.t);
      else dSel.push(item.t);
    });
  });

  const ready = hSel.length === H_TARGET && dSel.length === D_TARGET;
  document.getElementById("readyBadge").innerHTML = ready
    ? '<span class="ready-badge yes">Ready to submit</span>'
    : `<span class="ready-badge no">${H_TARGET - hSel.length > 0 ? (H_TARGET - hSel.length) + ' more headlines' : ''}${H_TARGET - hSel.length > 0 && D_TARGET - dSel.length > 0 ? ' + ' : ''}${D_TARGET - dSel.length > 0 ? (D_TARGET - dSel.length) + ' more descriptions' : ''}${hSel.length > H_TARGET ? (hSel.length - H_TARGET) + ' too many headlines' : ''}${dSel.length > D_TARGET ? ' ' + (dSel.length - D_TARGET) + ' too many descriptions' : ''}</span>`;

  let html = '<div class="rsa-section"><h4>Headlines (' + hSel.length + '/' + H_TARGET + ')</h4>';
  if (hSel.length) {
    hSel.forEach((t, i) => html += `<div class="rsa-item"><span class="rn">${i+1}.</span>${t}</div>`);
  } else {
    html += '<div class="rsa-empty">Select headlines on the left</div>';
  }
  html += '</div><div class="rsa-section"><h4>Descriptions (' + dSel.length + '/' + D_TARGET + ')</h4>';
  if (dSel.length) {
    dSel.forEach((t, i) => html += `<div class="rsa-item"><span class="rn">${i+1}.</span>${t}</div>`);
  } else {
    html += '<div class="rsa-empty">Select descriptions on the left</div>';
  }
  html += '</div>';

  document.getElementById("rsaSummary").innerHTML = html;
}

function renderPreviews() {
  const container = document.getElementById("previews");
  container.innerHTML = "";
  const hSel = [], dSel = [];
  cats.forEach(c => c.items.forEach(item => { if (!item.sel) return; (c.type === "h" ? hSel : dSel).push(item.t); }));
  if (hSel.length < 3 || dSel.length < 2) return;

  for (let i = 0; i < 3; i++) {
    const h = pick(hSel, 3);
    const d = pick(dSel, 2);
    const card = document.createElement("div");
    card.className = "preview-card";
    card.innerHTML = `
      <div class="pv-label">Sample combo ${i+1}</div>
      <div class="pv-h">${h.join(" | ")}</div>
      <div class="pv-u"><span class="badge">Ad</span> www.music-access.com</div>
      <div class="pv-d">${d.join(" ")}</div>
    `;
    container.appendChild(card);
  }
}

function pick(arr, n) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a.slice(0, n);
}

// ================================================
// EXPORT
// ================================================
function showExport() {
  const hSel = [], dSel = [];
  cats.forEach(c => c.items.forEach(item => { if (!item.sel) return; (c.type === "h" ? hSel : dSel).push(item.t); }));

  let t = `MEDLEY RSA — FINAL\n${"=".repeat(40)}\n\n`;
  t += `HEADLINES (${hSel.length}/${H_TARGET}):\n`;
  hSel.forEach((text, i) => t += `  ${i+1}. ${text} (${text.length}/30)\n`);
  t += `\nDESCRIPTIONS (${dSel.length}/${D_TARGET}):\n`;
  dSel.forEach((text, i) => t += `  ${i+1}. ${text} (${text.length}/90)\n`);

  if (hSel.length >= 3 && dSel.length >= 2) {
    t += "\nSAMPLE COMBOS:\n";
    for (let i = 0; i < 5; i++) {
      t += `\n  ${pick(hSel, 3).join(" | ")}\n  ${pick(dSel, 2).join(" ")}\n`;
    }
  }

  document.getElementById("exportPre").textContent = t;
  document.getElementById("overlay").classList.add("open");
}

function copyExport() {
  navigator.clipboard.writeText(document.getElementById("exportPre").textContent).then(() => {
    const btn = document.getElementById("copyBtn");
    btn.textContent = "Copied!";
    setTimeout(() => btn.textContent = "Copy to Clipboard", 1500);
  });
}

// Init
render();
renderPreviews();
</script>
</body>
</html>
