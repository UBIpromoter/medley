<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medley — Ad Copy</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #fff; color: #1a1a1a; min-height: 100vh; }

  /* Topbar */
  .topbar { position: sticky; top: 0; z-index: 100; background: #fff; border-bottom: 1px solid #e8e8e8; padding: 10px 24px; display: flex; align-items: center; gap: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
  .topbar h1 { font-size: 15px; font-weight: 700; color: #333; white-space: nowrap; }
  .counter-group { display: flex; gap: 12px; flex: 1; }
  .counter-pill { display: flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 16px; font-size: 12px; font-weight: 600; }
  .counter-pill.good { background: #e8f5e9; color: #2e7d32; }
  .counter-pill.warn { background: #fff8e1; color: #f57f17; }
  .counter-pill.over { background: #fce4ec; color: #c62828; }
  .counter-pill .num { font-size: 16px; font-weight: 800; }
  .save-status { font-size: 11px; color: #8da4be; transition: opacity 0.3s; }
  .save-status.flash { color: #2e7d32; }
  .topbar .refresh-btn { background: transparent; border: 1px solid #ddd; border-radius: 6px; padding: 4px 10px; font-size: 12px; color: #999; cursor: pointer; }
  .topbar .refresh-btn:hover { color: #666; border-color: #ccc; }

  /* Layout */
  .layout { display: grid; grid-template-columns: 1fr 380px; min-height: 100vh; }

  /* Main panel */
  .worksheet { padding: 16px 24px 100px; overflow-y: auto; max-height: 100vh; }
  .page-intro { padding: 8px 0 12px; font-size: 13px; color: #666; line-height: 1.6; }
  .page-intro strong { color: #333; }

  /* Section headers */
  .section-type { font-size: 14px; color: #1a73e8; font-weight: 600; margin: 24px 0 4px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
  .section-type .limit { font-size: 11px; color: #999; font-weight: 400; text-transform: none; letter-spacing: 0; }

  .cat-header { display: flex; align-items: center; gap: 8px; margin: 16px 0 2px; padding: 0 4px; }
  .cat-header h3 { font-size: 12px; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; flex: 1; }
  .cat-badge { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 10px; }
  .cat-badge.good { background: #e8f5e9; color: #2e7d32; }
  .cat-badge.over { background: #fce4ec; color: #c62828; }
  .cat-badge.under { background: #f5f5f5; color: #999; }

  /* Items */
  .item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 8px; margin: 3px 0; transition: all 0.15s; background: #fff; border: 1px solid transparent; }
  .item:hover { border-color: #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
  .item.kept { background: #f1f8f1; border-color: #c8e6c9; }
  .item.kept.excess { background: #fef0f0; border-color: #f5c6c6; }
  .item.available { background: #fff; }
  .item.killed { opacity: 0.45; }
  .item.killed .item-text { text-decoration: line-through; }
  .item.dragging { opacity: 0.3; }
  .item.drag-over-top { box-shadow: 0 -3px 0 0 #1a73e8; margin-top: 6px; }
  .item.drag-over-bottom { box-shadow: 0 3px 0 0 #1a73e8; margin-bottom: 6px; }

  .drag-handle { cursor: grab; color: #bbb; font-size: 16px; padding: 4px 6px; user-select: none; flex-shrink: 0; letter-spacing: -1px; }
  .drag-handle:active { cursor: grabbing; color: #666; }
  .item:hover .drag-handle { color: #888; }

  .rank-num { width: 18px; font-size: 10px; font-weight: 700; color: #66bb6a; text-align: center; flex-shrink: 0; }
  .item.kept.excess .rank-num { color: #e53935; }

  .vote-btns { display: flex; gap: 3px; flex-shrink: 0; }
  .vote-btn { width: 26px; height: 26px; border: 1px solid #dadce0; background: #fff; border-radius: 6px; cursor: pointer; font-size: 13px; color: #bbb; display: flex; align-items: center; justify-content: center; transition: all 0.12s; flex-shrink: 0; }
  .vote-btn:hover { background: #f0f0f0; }
  .vote-btn.kill:hover { background: #fce8e6; border-color: #d93025; color: #d93025; }
  .vote-btn.remix-on { background: #f3eefa; border-color: #9334e6; color: #9334e6; }
  .vote-btn.restore { color: #999; }
  .vote-btn.restore:hover { background: #e6f4ea; border-color: #34a853; color: #137333; }

  .item-text { flex: 1; font-size: 14px; padding: 2px 6px; border-radius: 3px; outline: none; min-width: 0; }
  .item-text:focus { background: #eef1ff; box-shadow: 0 0 0 2px rgba(26,115,232,0.12); }
  .item.remix .item-text { background: #f3eefa; }

  .item-note { font-size: 10px; color: #bbb; font-style: italic; flex-shrink: 0; max-width: 110px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .item-meta { font-size: 10px; color: #bbb; flex-shrink: 0; white-space: nowrap; min-width: 36px; text-align: right; }
  .item-meta.over { color: #d93025; font-weight: bold; }
  .item-meta.sweet { color: #137333; }

  /* Cut line */
  .cut-line { display: flex; align-items: center; gap: 8px; margin: 4px 8px; }
  .cut-line-bar { flex: 1; height: 1px; border-top: 2px dashed #e0e0e0; }
  .cut-line-label { font-size: 9px; color: #bbb; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }

  .drop-zone { padding: 0; margin: 0; border: 2px dashed transparent; border-radius: 8px; transition: all 0.2s; text-align: center; font-size: 11px; color: transparent; height: 4px; }
  .drop-zone.drag-hover { border-color: #1a73e8; background: #e8f0fe; color: #1a73e8; font-weight: 600; padding: 8px; height: auto; }

  /* Add your own — uses same .item layout */
  .item.add-item { border: 1px dashed #ddd; background: #fafafa; }
  .item.add-item:hover { border-color: #ccc; background: #f5f5f5; }
  .item.add-item .add-icon { width: 28px; font-size: 16px; color: #ccc; text-align: center; flex-shrink: 0; }
  .item.add-item .add-spacer { display: flex; gap: 3px; flex-shrink: 0; }
  .item.add-item .add-spacer-btn { width: 26px; height: 26px; visibility: hidden; }
  .item.add-item .add-field { flex: 1; font-size: 14px; font-family: inherit; padding: 2px 6px; border: none; background: transparent; outline: none; color: #333; min-width: 0; }
  .item.add-item .add-field::placeholder { color: #bbb; }
  .item.add-item .add-field:focus { background: #eef1ff; border-radius: 3px; box-shadow: 0 0 0 2px rgba(26,115,232,0.12); }

  /* Right panel */
  .preview-panel { background: #f8f9fa; border-left: 1px solid #e5e5e5; padding: 24px 20px 100px; overflow-y: auto; max-height: 100vh; position: sticky; top: 0; }
  .preview-panel h3 { font-size: 14px; color: #1a73e8; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .preview-panel .sub { font-size: 12px; color: #999; margin-bottom: 16px; }
  .shuffle-btn { background: #1a73e8; color: #fff; border: none; border-radius: 6px; padding: 5px 14px; font-size: 12px; font-weight: 600; cursor: pointer; margin-bottom: 12px; }
  .shuffle-btn:hover { background: #1557b0; }
  .preview-card { background: #fff; border: 1px solid #dadce0; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
  .pv-label { font-size: 10px; color: #999; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px; }
  .pv-h { font-size: 15px; color: #1a0dab; line-height: 1.3; margin-bottom: 2px; }
  .pv-u { font-size: 12px; color: #006621; margin-bottom: 3px; }
  .pv-u .badge { font-size: 10px; font-weight: bold; color: #006621; border: 1px solid #006621; border-radius: 2px; padding: 0 3px; margin-right: 3px; }
  .pv-d { font-size: 12px; color: #4d5156; line-height: 1.4; }
  .export-btn { background: #1a73e8; color: #fff; border: none; border-radius: 6px; padding: 7px 18px; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 16px; width: 100%; }
  .export-btn:hover { background: #1557b0; }

  /* Summary list */
  .summary-section { margin-top: 20px; }
  .summary-section h4 { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 6px; }
  .summary-item { font-size: 12px; padding: 2px 0; color: #333; border-bottom: 1px solid #eee; }
  .summary-item .rn { color: #bbb; font-size: 10px; margin-right: 4px; }
  .summary-empty { font-size: 12px; color: #ccc; font-style: italic; }

  /* Bottom bar */
  .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; z-index: 200; background: #fff; border-top: 1px solid #e8e8e8; padding: 10px 24px; display: flex; gap: 8px; align-items: center; justify-content: center; box-shadow: 0 -1px 4px rgba(0,0,0,0.04); }
  .nav-btn { background: transparent; color: #999; border: none; border-radius: 8px; padding: 8px 20px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s; }
  .nav-btn:hover { color: #666; background: #f5f5f5; }
  .nav-btn.active { background: #1a73e8; color: #fff; font-weight: 600; cursor: default; }
  .nav-btn.active:hover { background: #1a73e8; }
  .bar-sep { width: 1px; height: 20px; background: #e0e0e0; margin: 0 4px; }
  .util-btn { background: transparent; color: #bbb; border: 1px solid #e8e8e8; border-radius: 6px; padding: 6px 14px; font-size: 12px; cursor: pointer; transition: all 0.15s; }
  .util-btn:hover { color: #888; background: #fafafa; }

  /* Export overlay */
  .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 300; align-items: center; justify-content: center; }
  .overlay.open { display: flex; }
  .overlay-box { background: #fff; border-radius: 12px; max-width: 640px; width: 90%; max-height: 80vh; display: flex; flex-direction: column; }
  .overlay-header { padding: 16px 24px 10px; border-bottom: 1px solid #e5e5e5; border-radius: 12px 12px 0 0; display: flex; align-items: center; gap: 12px; }
  .overlay-header h3 { font-size: 16px; flex: 1; }
  .overlay-header button { background: #1a73e8; color: #fff; border: none; border-radius: 6px; padding: 7px 18px; font-size: 13px; font-weight: 600; cursor: pointer; }
  .overlay-header button.close-btn { background: #666; }
  .overlay-body { padding: 16px 24px 24px; overflow-y: auto; flex: 1; }
  .overlay-body pre { background: #f8f9fa; padding: 16px; border-radius: 8px; font-size: 13px; white-space: pre-wrap; line-height: 1.6; }

  @media (max-width: 900px) {
    .layout { grid-template-columns: 1fr; }
    .preview-panel { position: relative; max-height: none; border-left: none; border-top: 1px solid #e5e5e5; }
  }
</style>
</head>
<body>

<div class="topbar">
  <h1>Medley Ad Copy</h1>
  <div class="counter-group">
    <div class="counter-pill" id="hPill"><span class="num" id="hNum">0</span>&nbsp;/ 15 headlines</div>
    <div class="counter-pill" id="dPill"><span class="num" id="dNum">0</span>&nbsp;/ 4 descriptions</div>
  </div>
  <span class="save-status" id="saveStatus">Auto-saved</span>
  <button class="refresh-btn" onclick="location.reload()">Refresh</button>
</div>

<div class="layout">
<div class="worksheet">

  <div class="page-intro">
    <strong>Your ad copy.</strong> Items above the line are in the ad. Drag to reorder, <strong>&#10007;</strong> to remove, <strong>&#128260;</strong> to flag for a rewrite. You can edit any text directly or add your own.
  </div>

  <div class="section-type">Headlines <span class="limit">Google picks 3 of your 15 per impression</span></div>

  <div class="cat-header"><h3>The Gap</h3><span class="cat-badge" id="cb-gap"></span></div>
  <div id="s-gap"></div>

  <div class="cat-header"><h3>The Promise</h3><span class="cat-badge" id="cb-promise"></span></div>
  <div id="s-promise"></div>

  <div class="cat-header"><h3>Credibility</h3><span class="cat-badge" id="cb-cred"></span></div>
  <div id="s-cred"></div>

  <div class="cat-header"><h3>Audience</h3><span class="cat-badge" id="cb-aud"></span></div>
  <div id="s-aud"></div>

  <div class="cat-header"><h3>Format</h3><span class="cat-badge" id="cb-cta"></span></div>
  <div id="s-cta"></div>

  <div class="section-type" style="margin-top:32px;">Descriptions <span class="limit">Google picks 2 of your 4 per impression</span></div>

  <div class="cat-header"><h3>For Teachers</h3><span class="cat-badge" id="cb-dt"></span></div>
  <div id="s-dt"></div>

  <div class="cat-header"><h3>For Admins</h3><span class="cat-badge" id="cb-da"></span></div>
  <div id="s-da"></div>

  <div class="cat-header"><h3>Universal</h3><span class="cat-badge" id="cb-du"></span></div>
  <div id="s-du"></div>
</div>

<!-- Right panel -->
<div class="preview-panel">
  <h3>Live Preview</h3>
  <p class="sub">Google will mix your headlines and descriptions — here's what that might look like</p>
  <button class="shuffle-btn" onclick="renderPreviews()">Shuffle</button>
  <div id="previews"></div>
  <div class="summary-section" id="summary"></div>
  <button class="export-btn" onclick="showExport()">Export Copy</button>
</div>
</div>

<div class="bottom-bar">
  <button class="nav-btn active">Ad Copy</button>
  <button class="nav-btn" onclick="location.href='index.html'">Visual Preview</button>
  <span class="bar-sep"></span>
  <button class="util-btn" onclick="downloadBackup()">Download Backup</button>
</div>

<!-- Export overlay -->
<div class="overlay" id="overlay">
  <div class="overlay-box">
    <div class="overlay-header">
      <h3>Your Ad Copy</h3>
      <button onclick="copyExport()" id="copyBtn">Copy to Clipboard</button>
      <button class="close-btn" onclick="document.getElementById('overlay').classList.remove('open')">Close</button>
    </div>
    <div class="overlay-body"><pre id="exportPre"></pre></div>
  </div>
</div>

<script>
const STORAGE_KEY = "medley-ad-v1";
const H_MAX = 15, D_MAX = 4;
const DESC_SWEET = [40, 65];

function loadStore() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || null; } catch { return null; } }
function saveStore(s) { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
function slug(t) { return t.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "").slice(0, 50); }
function pick(a, n) { const b=[...a]; for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];} return b.slice(0, n); }
function esc(s) { const d=document.createElement("div"); d.textContent=s; return d.innerHTML; }

// =============================================
// DATA — curated starting set
// keep: true = above cut line (in the ad)
// keep: false = below cut line (available)
// killed: true = removed (can restore)
// =============================================
const cats = [
  { id:"gap", type:"h", label:"The Gap", target:3, containerEl:"s-gap", badgeEl:"cb-gap", max:30, items:[
    { t:"Your Degree Didn't Cover This", keep:true },
    { t:"Not Trained for This?", keep:true },
    { t:"When Inclusion Feels Hard", keep:true },
    { t:"What Your Degree Missed", keep:false },
    { t:"The PD You Actually Need", keep:false },
  ]},
  { id:"promise", type:"h", label:"The Promise", target:4, containerEl:"s-promise", badgeEl:"cb-promise", max:30, items:[
    { t:"Tools for Monday Morning", keep:true },
    { t:"Strategies That Actually Work", keep:true },
    { t:"Teach the Kids You Have", keep:true },
    { t:"Feel Empowered to Teach", keep:true },
    { t:"Hands-On Music PD", keep:false },
    { t:"Music for ALL Learners", keep:false },
    { t:"Ready for Next Monday", keep:false },
  ]},
  { id:"cred", type:"h", label:"Credibility", target:3, containerEl:"s-cred", badgeEl:"cb-cred", max:30, items:[
    { t:"By Music Teachers", keep:true },
    { t:"Real Teachers Not Consultants", keep:true },
    { t:"Humans, Not Curriculum", keep:true, note:"Jess's philosophy" },
    { t:"Watch the Children", keep:false, note:"Jess's mantra" },
    { t:"We See Kids, Not Labels", keep:false },
    { t:"Made by Music Teachers", keep:false },
  ]},
  { id:"aud", type:"h", label:"Audience", target:2, containerEl:"s-aud", badgeEl:"cb-aud", max:30, items:[
    { t:"For Music Teachers", keep:true },
    { t:"Equip Your Music Teachers", keep:true },
    { t:"Schools & Districts", keep:false },
  ]},
  { id:"cta", type:"h", label:"Format", target:3, containerEl:"s-cta", badgeEl:"cb-cta", max:30, items:[
    { t:"Inclusive Music PD", keep:true },
    { t:"Adaptive Music Ed", keep:true },
    { t:"Virtual & In-Person", keep:true },
  ]},

  { id:"dt", type:"d", label:"For Teachers", target:2, containerEl:"s-dt", badgeEl:"cb-dt", max:90, items:[
    { t:"We teach what your degree didn't. By music teachers.", keep:true },
    { t:"You were trained for music, not disability. We bridge that gap.", keep:true },
    { t:"Not theory. Hands-on skills your program skipped. Use them Monday.", keep:false },
    { t:"Weren't trained for this? We'll get you there. Practical inclusion PD.", keep:false },
    { t:"Fill the gap your degree left. Real strategies for inclusive classrooms.", keep:false },
    { t:"Feel empowered to include every student. Monday will look different.", keep:false },
  ]},
  { id:"da", type:"d", label:"For Admins", target:1, containerEl:"s-da", badgeEl:"cb-da", max:90, items:[
    { t:"Your music teachers weren't trained for inclusion. We can help.", keep:true },
    { t:"Every child in your district deserves music. Equip your team.", keep:false },
    { t:"PD teachers actually request. By music teachers, not outsiders.", keep:false },
  ]},
  { id:"du", type:"d", label:"Universal", target:1, containerEl:"s-du", badgeEl:"cb-du", max:90, items:[
    { t:"Inclusion PD by music teachers. Practical. Hands-on.", keep:true },
    { t:"Strategies you didn't learn in school. Virtual & in-person.", keep:false },
    { t:"The training music teachers actually need. Inclusive, adaptive, hands-on.", keep:false },
  ]},
];

// Generate stable IDs
cats.forEach(cat => cat.items.forEach(item => {
  if (!item.id) item.id = slug(item.t);
  if (item.killed === undefined) item.killed = false;
  if (item.remix === undefined) item.remix = false;
}));

// =============================================
// PERSISTENCE
// =============================================
function applyStore() {
  const store = loadStore();
  if (!store) return;
  cats.forEach(cat => {
    const saved = store[cat.id];
    if (!saved) return;
    if (saved.items) {
      cat.items.forEach(item => {
        const s = saved.items[item.id];
        if (!s) return;
        if (s.keep !== undefined) item.keep = s.keep;
        if (s.killed !== undefined) item.killed = s.killed;
        if (s.remix !== undefined) item.remix = s.remix;
        if (s.t) item.t = s.t;
      });
      // Restore user-added items
      Object.keys(saved.items).forEach(id => {
        if (!cat.items.find(i => i.id === id)) {
          const s = saved.items[id];
          cat.items.push({ t:s.t, keep:s.keep, killed:s.killed||false, remix:s.remix||false, id });
        }
      });
    }
    if (saved.order) {
      const m = {}; saved.order.forEach((id,i) => m[id] = i);
      cat.items.sort((a,b) => ((m[a.id]??999) - (m[b.id]??999)));
    }
  });
}

function persistAll() {
  const store = {};
  cats.forEach(cat => {
    store[cat.id] = {
      order: cat.items.map(i => i.id),
      items: {}
    };
    cat.items.forEach(item => {
      store[cat.id].items[item.id] = { keep:item.keep, killed:item.killed, remix:item.remix, t:item.t };
    });
  });
  saveStore(store);
  flashSaved();
}

let saveTimer;
function flashSaved() {
  const el = document.getElementById("saveStatus");
  if (!el) return;
  el.textContent = "Saved";
  el.classList.add("flash");
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => { el.textContent = "Auto-saved"; el.classList.remove("flash"); }, 1500);
}

function downloadBackup() {
  const store = loadStore();
  const blob = new Blob([JSON.stringify(store, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `medley-ad-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

applyStore();

// =============================================
// DRAG STATE
// =============================================
let dragCat = null, dragItem = null;

// =============================================
// RENDER
// =============================================
function render() {
  cats.forEach(cat => {
    const container = document.getElementById(cat.containerEl);
    container.innerHTML = "";

    const kept = cat.items.filter(i => i.keep && !i.killed);
    const available = cat.items.filter(i => !i.keep && !i.killed);
    const killed = cat.items.filter(i => i.killed);

    // Kept items (above the line)
    kept.forEach((item, i) => {
      const isExcess = i >= cat.target;
      renderRow(container, item, i + 1, cat, "kept", isExcess);
    });

    // Drop zone + cut line
    if (available.length > 0 || killed.length > 0) {
      const zone = document.createElement("div");
      zone.className = "drop-zone";
      zone.textContent = "Drop here to include in ad";
      zone.addEventListener("dragover", e => { e.preventDefault(); if (dragCat === cat) zone.classList.add("drag-hover"); });
      zone.addEventListener("dragleave", () => zone.classList.remove("drag-hover"));
      zone.addEventListener("drop", e => {
        e.preventDefault(); zone.classList.remove("drag-hover");
        if (dragCat !== cat || !dragItem) return;
        dragItem.keep = true;
        if (dragItem.killed) dragItem.killed = false;
        render();
      });
      container.appendChild(zone);

      const line = document.createElement("div");
      line.className = "cut-line";
      line.innerHTML = `<span class="cut-line-label">${kept.length}/${cat.target} in ad</span><div class="cut-line-bar"></div>`;
      container.appendChild(line);
    }

    // Available items (below the line)
    available.forEach(item => renderRow(container, item, null, cat, "available", false));

    // Killed items
    killed.forEach(item => renderKilledRow(container, item, cat));

    // Add your own row
    renderAddRow(container, cat);

    // Category badge
    const badge = document.getElementById(cat.badgeEl);
    badge.textContent = `${kept.length}/${cat.target}`;
    badge.className = "cat-badge " + (kept.length === cat.target ? "good" : kept.length > cat.target ? "over" : "under");
  });

  updateCounters();
  renderPreviews();
  renderSummary();
  persistAll();
}

function renderRow(container, item, rank, cat, state, isExcess) {
  const row = document.createElement("div");
  row.className = "item " + state + (isExcess ? " excess" : "") + (item.remix ? " remix" : "");
  row.draggable = true;

  // Drag handlers
  row.addEventListener("dragstart", e => {
    dragCat = cat; dragItem = item;
    row.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
  });
  row.addEventListener("dragend", () => {
    row.classList.remove("dragging");
    document.querySelectorAll(".drag-over-top,.drag-over-bottom").forEach(el => el.classList.remove("drag-over-top","drag-over-bottom"));
  });
  row.addEventListener("dragover", e => {
    e.preventDefault();
    if (dragCat !== cat) return;
    const rect = row.getBoundingClientRect();
    const midY = rect.top + rect.height / 2;
    row.classList.toggle("drag-over-top", e.clientY < midY);
    row.classList.toggle("drag-over-bottom", e.clientY >= midY);
  });
  row.addEventListener("dragleave", () => row.classList.remove("drag-over-top","drag-over-bottom"));
  row.addEventListener("drop", e => {
    e.preventDefault(); row.classList.remove("drag-over-top","drag-over-bottom");
    if (dragCat !== cat || !dragItem) return;
    if (dragItem === item) return;

    // Remove dragged item from array
    const fromIdx = cat.items.indexOf(dragItem);
    cat.items.splice(fromIdx, 1);

    // Insert at new position
    const toIdx = cat.items.indexOf(item);
    const insertAfter = e.clientY >= row.getBoundingClientRect().top + row.getBoundingClientRect().height / 2;
    cat.items.splice(insertAfter ? toIdx + 1 : toIdx, 0, dragItem);

    // Match the keep state of where it was dropped
    dragItem.keep = item.keep;
    if (dragItem.killed) dragItem.killed = false;

    render();
  });

  // Drag handle
  const handle = document.createElement("span");
  handle.className = "drag-handle";
  handle.textContent = "\u2630";

  // Rank
  const rk = document.createElement("span");
  rk.className = "rank-num";
  rk.textContent = rank || "";

  // Buttons
  const btns = document.createElement("div");
  btns.className = "vote-btns";

  const killBtn = document.createElement("button");
  killBtn.className = "vote-btn kill";
  killBtn.textContent = "\u2717";
  killBtn.title = "Remove";
  killBtn.onclick = e => { e.stopPropagation(); item.killed = true; item.keep = false; item.remix = false; render(); };

  const remixBtn = document.createElement("button");
  remixBtn.className = "vote-btn" + (item.remix ? " remix-on" : "");
  remixBtn.textContent = "\uD83D\uDD04";
  remixBtn.title = "Flag for rewrite";
  remixBtn.onclick = e => { e.stopPropagation(); item.remix = !item.remix; render(); };

  btns.append(killBtn, remixBtn);

  // Text
  const text = document.createElement("span");
  text.className = "item-text";
  text.contentEditable = true;
  text.textContent = item.t;
  text.addEventListener("input", () => {
    item.t = text.textContent;
    item.id = slug(item.t);
    updateMeta(meta, item.t.length, cat);
    persistAll();
  });
  text.addEventListener("keydown", e => { if (e.key === "Enter") { e.preventDefault(); text.blur(); }});

  // Note
  const noteEl = document.createElement("span");
  if (item.note) {
    noteEl.className = "item-note";
    noteEl.textContent = item.note;
    noteEl.title = item.note;
  }

  // Char count
  const meta = document.createElement("span");
  updateMeta(meta, item.t.length, cat);

  row.append(handle, rk, btns, text);
  if (item.note) row.append(noteEl);
  row.append(meta);
  container.appendChild(row);
}

function renderKilledRow(container, item, cat) {
  const row = document.createElement("div");
  row.className = "item killed";

  const spacer = document.createElement("span");
  spacer.style.width = "30px";
  spacer.style.flexShrink = "0";

  const rk = document.createElement("span");
  rk.className = "rank-num";

  const btns = document.createElement("div");
  btns.className = "vote-btns";
  const restoreBtn = document.createElement("button");
  restoreBtn.className = "vote-btn restore";
  restoreBtn.textContent = "\u2713";
  restoreBtn.title = "Bring back";
  restoreBtn.onclick = () => { item.killed = false; render(); };
  btns.append(restoreBtn);

  const text = document.createElement("span");
  text.className = "item-text";
  text.textContent = item.t;

  const meta = document.createElement("span");
  updateMeta(meta, item.t.length, cat);

  row.append(spacer, rk, btns, text, meta);
  container.appendChild(row);
}

function updateMeta(el, len, cat) {
  el.textContent = `${len}/${cat.max}`;
  el.className = "item-meta";
  if (len > cat.max) el.classList.add("over");
  else if (cat.type === "d" && len >= DESC_SWEET[0] && len <= DESC_SWEET[1]) el.classList.add("sweet");
}

// =============================================
// ADD YOUR OWN — rendered as a matching item row
// =============================================
function renderAddRow(container, cat) {
  const row = document.createElement("div");
  row.className = "item add-item";

  // + icon where drag handle would be
  const icon = document.createElement("span");
  icon.className = "add-icon";
  icon.textContent = "+";

  // Empty rank spacer
  const rk = document.createElement("span");
  rk.className = "rank-num";

  // Invisible button spacers for alignment
  const btns = document.createElement("div");
  btns.className = "add-spacer";
  btns.innerHTML = '<span class="add-spacer-btn"></span><span class="add-spacer-btn"></span>';

  // Input field where item-text would be
  const input = document.createElement("input");
  input.className = "add-field";
  input.type = "text";
  input.placeholder = "Add your own — press Enter";
  input.maxLength = cat.max;

  // Char counter where item-meta would be
  const meta = document.createElement("span");
  meta.className = "item-meta";
  meta.textContent = `0/${cat.max}`;

  input.addEventListener("input", () => {
    const len = input.value.length;
    meta.textContent = `${len}/${cat.max}`;
    meta.className = "item-meta" + (len > cat.max ? " over" : "");
  });

  input.addEventListener("keydown", e => {
    if (e.key !== "Enter") return;
    const text = input.value.trim();
    if (!text) return;
    cat.items.push({ t: text, keep: false, killed: false, remix: false, id: slug(text) });
    render();
  });

  row.append(icon, rk, btns, input, meta);
  container.appendChild(row);
}

// =============================================
// COUNTERS
// =============================================
function updateCounters() {
  const hKept = cats.filter(c => c.type === "h").reduce((n, c) => n + c.items.filter(i => i.keep && !i.killed).length, 0);
  const dKept = cats.filter(c => c.type === "d").reduce((n, c) => n + c.items.filter(i => i.keep && !i.killed).length, 0);

  document.getElementById("hNum").textContent = hKept;
  document.getElementById("dNum").textContent = dKept;

  const hEl = document.getElementById("hPill");
  const dEl = document.getElementById("dPill");
  hEl.className = "counter-pill " + (hKept === H_MAX ? "good" : hKept > H_MAX ? "over" : "warn");
  dEl.className = "counter-pill " + (dKept === D_MAX ? "good" : dKept > D_MAX ? "over" : "warn");
}

// =============================================
// PREVIEWS
// =============================================
function renderPreviews() {
  const container = document.getElementById("previews");
  container.innerHTML = "";
  const hKept = [], dKept = [];
  cats.forEach(c => c.items.forEach(item => {
    if (!item.keep || item.killed) return;
    (c.type === "h" ? hKept : dKept).push(item.t);
  }));

  if (hKept.length < 3 || dKept.length < 2) {
    container.innerHTML = '<div style="font-size:12px;color:#999;font-style:italic;padding:8px 0;">Need at least 3 headlines and 2 descriptions above the line for previews.</div>';
    return;
  }

  for (let i = 0; i < 4; i++) {
    const h = pick(hKept, 3), d = pick(dKept, 2);
    const card = document.createElement("div");
    card.className = "preview-card";
    card.innerHTML = `<div class="pv-label">Combo ${i+1}</div><div class="pv-h">${esc(h[0])} | ${esc(h[1])} | ${esc(h[2])}</div><div class="pv-u"><span class="badge">Ad</span> www.music-access.com</div><div class="pv-d">${esc(d[0])} ${esc(d[1])}</div>`;
    container.appendChild(card);
  }
}

function renderSummary() {
  const container = document.getElementById("summary");
  const hKept = [], dKept = [];
  cats.forEach(c => c.items.forEach(item => {
    if (!item.keep || item.killed) return;
    (c.type === "h" ? hKept : dKept).push(item.t);
  }));

  let html = `<h4>In the ad: ${hKept.length} headlines, ${dKept.length} descriptions</h4>`;
  hKept.forEach((t, i) => html += `<div class="summary-item"><span class="rn">${i+1}.</span> ${esc(t)}</div>`);
  if (dKept.length) {
    html += '<div style="margin-top:8px;"></div>';
    dKept.forEach((t, i) => html += `<div class="summary-item"><span class="rn">${i+1}.</span> ${esc(t)}</div>`);
  }
  container.innerHTML = html;
}

// =============================================
// EXPORT
// =============================================
function showExport() {
  const hKept = [], dKept = [], remixItems = [];
  cats.forEach(c => c.items.forEach(item => {
    if (item.keep && !item.killed) (c.type === "h" ? hKept : dKept).push(item.t);
    if (item.remix && !item.killed) remixItems.push({ t: item.t, cat: c.label, type: c.type === "h" ? "headline" : "description" });
  }));

  let t = `MEDLEY AD COPY\n${"=".repeat(40)}\n\n`;
  t += `HEADLINES (${hKept.length}/${H_MAX}):\n`;
  hKept.forEach((text, i) => t += `  ${i+1}. ${text} (${text.length}/30)\n`);
  t += `\nDESCRIPTIONS (${dKept.length}/${D_MAX}):\n`;
  dKept.forEach((text, i) => t += `  ${i+1}. ${text} (${text.length}/90)\n`);

  if (remixItems.length) {
    t += `\nFLAGGED FOR REWRITE (${remixItems.length}):\n`;
    remixItems.forEach((r, i) => t += `  ${i+1}. [${r.cat}] ${r.t}\n`);
  }

  if (hKept.length >= 3 && dKept.length >= 2) {
    t += "\nSAMPLE COMBOS:\n";
    for (let i = 0; i < 5; i++) t += `\n  ${pick(hKept, 3).join(" | ")}\n  ${pick(dKept, 2).join(" ")}\n`;
  }

  document.getElementById("exportPre").textContent = t;
  document.getElementById("overlay").classList.add("open");
}

function copyExport() {
  navigator.clipboard.writeText(document.getElementById("exportPre").textContent).then(() => {
    const btn = document.getElementById("copyBtn");
    btn.textContent = "Copied!";
    setTimeout(() => btn.textContent = "Copy to Clipboard", 1500);
  });
}

// Init
render();
</script>
</body>
</html>
